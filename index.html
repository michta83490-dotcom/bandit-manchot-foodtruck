<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>La Bo√Æte √† Nems - Jeu</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      text-align:center;
      background:#111;
      color:#fff;
      margin:0;
      padding:24px 12px;
    }
    h1{margin:0 0 8px;font-size:34px;letter-spacing:1px}
    .sub{opacity:.9;margin:0 0 18px}
    .card{
      max-width:560px;
      margin:0 auto;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:18px 16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .reels{
      display:flex;
      gap:14px;
      justify-content:center;
      margin:10px 0 14px;
    }
    .reel{
      width:110px;height:110px;
      border-radius:14px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      display:flex;align-items:center;justify-content:center;
      font-size:56px;
      position:relative;
      overflow:hidden;
    }
    .sym{transition:transform .12s ease, filter .12s ease;}
    .spinning .sym{filter:blur(2px);transform:scale(1.08)}
    .btn{
      border:0;
      border-radius:12px;
      padding:14px 22px;
      font-size:18px;
      cursor:pointer;
      font-weight:700;
    }
    .spin{
      background:#f3c623;
      color:#111;
      box-shadow:0 8px 18px rgba(243,198,35,.22);
      width:170px;
    }
    .spin:disabled{opacity:.55;cursor:not-allowed}
    .msg{
      margin:12px 0 6px;
      min-height:26px;
      font-size:18px;
      font-weight:700;
    }
    .msg.ok{color:#60ff85}
    .msg.no{color:#ff6b6b}
    .codeBox{
      display:none;
      margin:10px auto 0;
      max-width:420px;
      padding:12px 12px;
      border-radius:12px;
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.14);
    }
    #claimCode{font-size:20px;letter-spacing:1px}
    #countdown{margin-top:8px;font-size:15px;font-weight:700}
    .rowBtns{
      display:flex;gap:10px;flex-wrap:wrap;justify-content:center;
      margin-top:14px;
    }
    .linkBtn{background:#e9e9e9;color:#111}
    .greenBtn{background:#3fd36f;color:#111}
    .legend{
      text-align:left;
      margin-top:14px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.12);
      font-size:14px;
      line-height:1.35;
      opacity:.95;
    }
    .legend b{opacity:1}
    .tiny{opacity:.85;font-size:13px}
    .hr{height:1px;background:rgba(255,255,255,.12);margin:10px 0}
  </style>
</head>

<body>
  <h1>üé∞ LA BO√éTE √Ä NEMS üé∞</h1>
  <p class="sub">Joue pour le fun‚Ä¶ et parfois un cadeau üòã</p>

  <div class="card">
    <div class="reels" id="reels">
      <div class="reel" id="r1"><div class="sym" id="s1">üçí</div></div>
      <div class="reel" id="r2"><div class="sym" id="s2">‚≠ê</div></div>
      <div class="reel" id="r3"><div class="sym" id="s3">7Ô∏è‚É£</div></div>
    </div>

    <button class="btn spin" id="spinBtn" onclick="spin()">SPIN</button>

    <div class="msg" id="msg"></div>

    <div class="codeBox" id="codeBox">
      <div>Code de r√©clamation (valable 10 min) :</div>
      <div style="margin-top:6px"><b id="claimCode"></b></div>
      <div id="countdown"></div>
      <div class="tiny" style="margin-top:6px">√Ä montrer au camion (ou √† donner au t√©l√©phone).</div>
    </div>

    <div class="rowBtns">
      <button class="btn linkBtn" onclick="goSite()">D√©couvrir La Bo√Æte √† Nems</button>
      <button class="btn greenBtn" onclick="callPhone()">Commander (t√©l√©phone)</button>
      <button class="btn greenBtn" onclick="goWhatsApp()">Commander (WhatsApp)</button>
    </div>

    <div class="legend">
      <b>L√©gende des gains</b><br>
      üçíüçíüçí = 1 boisson soft<br>
      ‚≠ê‚≠ê‚≠ê = 1 box ap√©ro 8 pi√®ces<br>
      7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£ = 1 Pad tha√Ø traditionnel nature
      <div class="hr"></div>
      üí∂ Commande minimum : <b>30‚Ç¨</b><br>
      üéÅ Cadeau remis uniquement lors d‚Äôune commande (selon disponibilit√©).<br>
      ‚è≥ Gain valable <b>48h</b> √† compter du gain.<br>
      ‚õî Si tu gagnes : tu ne peux plus rejouer pendant <b>24h</b> sur ce t√©l√©phone.<br>
      üîê Code de r√©clamation g√©n√©r√© (valable <b>10 min</b>) pour limiter les profiteurs.
    </div>
  </div>

<script>
/* =========================
   R√âGLAGES
========================= */
const SITE_URL = "https://la-boite-a-nems-le-muy.eatbu.com";
const PHONE_NUMBER = "+33782549660";

/* Probabilit√©s (par tentative)
   - soft ~ 1/5
   - box ~ 1/8
   - pad ~ 1/20
   Le reste = perdu
*/
const P_SOFT = 1/5;
const P_BOX  = 1/8;
const P_PAD  = 1/20;

const BLOCK_AFTER_WIN_MS = 24 * 60 * 60 * 1000; // 24h
const GAIN_VALID_MS = 48 * 60 * 60 * 1000;      // 48h
const CLAIM_CODE_VALID_MS = 10 * 60 * 1000;     // 10 min

const SYMS = ["üçí","‚≠ê","7Ô∏è‚É£"];

const spinBtn = document.getElementById("spinBtn");
const reelsEl = document.getElementById("reels");
const msgEl = document.getElementById("msg");
const codeBoxEl = document.getElementById("codeBox");
const claimCodeEl = document.getElementById("claimCode");
const countdownEl = document.getElementById("countdown");

let countdownTimer = null;

/* =========================
   OUTILS UI
========================= */
function setMsg(text, kind){
  msgEl.textContent = text || "";
  msgEl.className = "msg" + (kind ? " " + kind : "");
}
function showCodeBox(show){
  codeBoxEl.style.display = show ? "block" : "none";
}
function randInt(n){ return Math.floor(Math.random()*n); }
function formatDHMS(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  const pad = (x)=> String(x).padStart(2,"0");
  if(d>0) return ${d}j ${pad(h)}h ${pad(m)}m ${pad(sec)}s;
  return ${pad(h)}h ${pad(m)}m ${pad(sec)}s;
}

/* =========================
   BLOQUAGE 24H APRES GAIN
========================= */
function isBlockedAfterWin(){
  const t = parseInt(localStorage.getItem("lastWinAt") || "0", 10);
  if(!t) return false;
  return (Date.now() - t) < BLOCK_AFTER_WIN_MS;
}
function remainingBlockMs(){
  const t = parseInt(localStorage.getItem("lastWinAt") || "0", 10);
  return Math.max(0, BLOCK_AFTER_WIN_MS - (Date.now() - t));
}

/* =========================
   COMPTE A REBOURS 48H (GAIN)
========================= */
function startGainCountdown(){
  const winAt = parseInt(localStorage.getItem("lastWinAt") || "0", 10);
  if(!winAt){ countdownEl.textContent = ""; return; }

  const end = winAt + GAIN_VALID_MS;

  function tick(){
    const now = Date.now();
    const diff = end - now;
    if(diff <= 0){
      countdownEl.textContent = "‚õî Gain expir√©.";
      return;
    }
    countdownEl.textContent = "‚è≥ Gain valable encore : " + formatDHMS(diff);
  }

  tick();
  clearInterval(countdownTimer);
  countdownTimer = setInterval(tick, 1000);
}

/* =========================
   CODE DE R√âCLAMATION 10 MIN
========================= */
function generateClaimCode(){
  const now = new Date();
  const dd = String(now.getDate()).padStart(2,"0");
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const yy = String(now.getFullYear()).slice(-2);
  const rnd = Math.floor(1000 + Math.random()*9000);
  const code = NEMS-${dd}${mm}${yy}-${rnd};
  localStorage.setItem("claimCode", code);
  localStorage.setItem("claimCodeAt", String(Date.now()));
  return code;
}
function getClaimCodeIfValid(){
  const code = localStorage.getItem("claimCode");
  const t = parseInt(localStorage.getItem("claimCodeAt") || "0", 10);
  if(!code || !t) return null;
  if(Date.now() - t > CLAIM_CODE_VALID_MS) return null;
  return code;
}
function claimCountdownText(){
  const t = parseInt(localStorage.getItem("claimCodeAt") || "0", 10);
  if(!t) return "";
  const left = CLAIM_CODE_VALID_MS - (Date.now() - t);
  if(left <= 0) return "‚õî Code expir√©.";
  return "üîê Code valable encore : " + formatDHMS(left);
}
function startClaimCountdown(){
  function tick(){
    const code = getClaimCodeIfValid();
    if(!code){
      // on laisse le compte √† rebours gain (48h) mais on indique code expir√©
      countdownEl.textContent = "‚õî Code expir√© (demande-en un nouveau au camion).";
      return;
    }
    countdownEl.textContent = claimCountdownText() + " ‚Ä¢ " + (localStorage.getItem("lastWinAt") ? "" : "");
  }
  tick();
  setInterval(tick, 1000);
}

/* =========================
   SPIN (animation + r√©sultat)
========================= */
function setReels(a,b,c){
  document.getElementById("s1").textContent = a;
  document.getElementById("s2").textContent = b;
  document.getElementById("s3").textContent = c;
}

function animateSpin(durationMs=900){
  return new Promise((resolve)=>{
    reelsEl.classList.add("spinning");
    const start = Date.now();
    const timer = setInterval(()=>{
      setReels(SYMS[randInt(3)], SYMS[randInt(3)], SYMS[randInt(3)]);
      if(Date.now() - start >= durationMs){
        clearInterval(timer);
        reelsEl.classList.remove("spinning");
        resolve();
      }
    }, 85);
  });
}

function decideOutcome(){
  // On force "3 identiques" seulement quand c'est gagnant
  const r = Math.random();

  if(r < P_PAD) return {sym:"7Ô∏è‚É£", text:"üéâ Gagn√© ! 1 Pad tha√Ø traditionnel nature."};
  if(r < P_PAD + P_BOX) return {sym:"‚≠ê", text:"üéâ Gagn√© ! 1 box ap√©ro 8 pi√®ces."};
  if(r < P_PAD + P_BOX + P_SOFT) return {sym:"üçí", text:"üéâ Gagn√© ! 1 boisson soft."};

  return null; // perdu
}

async function spin(){
  // blocage apr√®s gain 24h
  if(isBlockedAfterWin()){
    const left = remainingBlockMs();
    setMsg("‚õî Tu as d√©j√† gagn√© r√©cemment. Reviens dans " + formatDHMS(left) + ".", "no");
    return;
  }

  // on masque le code tant qu'on n'a pas gagn√©
  showCodeBox(false);
  setMsg("", "");

  spinBtn.disabled = true;
  await animateSpin(950);

  const outcome = decideOutcome();

  if(!outcome){
    // perdu : on laisse une combinaison random (d√©j√† affich√©e)
    setMsg("üòã Pas gagn√© cette fois‚Ä¶ retente quand tu veux !", "no");
    spinBtn.disabled = false;
    return;
  }

  // gagnant : on affiche 3 identiques
  setReels(outcome.sym, outcome.sym, outcome.sym);

  // enregistrement gain
  localStorage.setItem("lastWinAt", String(Date.now()));

  // code de r√©clamation 10 min
  const claimCode = generateClaimCode();
  claimCodeEl.textContent = claimCode;

  setMsg(outcome.text, "ok");
  showCodeBox(true);

  // compte √† rebours 48h + info code 10 min
  startGainCountdown();
  // et on met aussi l'info "code 10 min" dans le m√™me emplacement (simple)
  clearInterval(countdownTimer);
  countdownTimer = setInterval(()=>{
    const codeValid = getClaimCodeIfValid();
    const gainEnd = parseInt(localStorage.getItem("lastWinAt")||"0",10) + GAIN_VALID_MS;
    const gainLeft = gainEnd - Date.now();

    const gainTxt = gainLeft > 0 ? ("‚è≥ Gain valable encore : " + formatDHMS(gainLeft)) : "‚õî Gain expir√©.";
    const codeTxt = codeValid ? (" ‚Ä¢ üîê Code : " + claimCountdownText().replace("üîê Code valable encore : ","")) : " ‚Ä¢ ‚õî Code expir√©.";

    countdownEl.textContent = gainTxt + codeTxt;
  }, 1000);

  // bouton reactiv√© mais bloqu√© par la r√®gle 24h
  spinBtn.disabled = false;
}

/* =========================
   BOUTONS
========================= */
function goSite(){ window.open(SITE_URL, "_blank"); }
function callPhone(){ window.location.href = "tel:" + PHONE_NUMBER; }
function goWhatsApp(){
  const msg = encodeURIComponent("Bonjour ! Je voudrais commander (minimum 30‚Ç¨). J‚Äôai aussi un code cadeau si besoin üôÇ");
  const num = PHONE_NUMBER.replace(/\+/g,"").replace(/\s/g,"");
  window.open("https://wa.me/" + num + "?text=" + msg, "_blank");
}

/* =========================
   INIT AU CHARGEMENT
========================= */
(function init(){
  // Si d√©j√† gagn√© : affiche code si encore valable + countdown 48h
  const winAt = parseInt(localStorage.getItem("lastWinAt") || "0", 10);
  if(winAt){
    // afficher le compte √† rebours 48h m√™me en revenant plus tard
    showCodeBox(true);

    const code = getClaimCodeIfValid();
    if(code){
      claimCodeEl.textContent = code;
      setMsg("‚úÖ Tu as d√©j√† gagn√©. Utilise ton code (10 min) + gain valable 48h.", "ok");
    }else{
      claimCodeEl.textContent = "‚Äî";
      setMsg("‚úÖ Tu as d√©j√† gagn√©. Le code 10 min a expir√© (on peut te le r√©g√©n√©rer au camion).", "ok");
    }

    // lancer l'affichage combin√© gain+code
    clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      const codeValid = getClaimCodeIfValid();
      const gainEnd = winAt + GAIN_VALID_MS;
      const gainLeft = gainEnd - Date.now();

      const gainTxt = gainLeft > 0 ? ("‚è≥ Gain valable encore : " + formatDHMS(gainLeft)) : "‚õî Gain expir√©.";
      const codeTxt = codeValid ? (" ‚Ä¢ üîê Code : " + claimCountdownText().replace("üîê Code valable encore : ","")) : " ‚Ä¢ ‚õî Code expir√©.";

      countdownEl.textContent = gainTxt + codeTxt;
    }, 1000);
  }

  // Si bloqu√© 24h : petit message
  if(isBlockedAfterWin()){
    const left = remainingBlockMs();
    setMsg("‚õî Tu as d√©j√† gagn√© r√©cemment. Reviens dans " + formatDHMS(left) + ".", "no");
  }
})();
</script>

</body>
</html>
