<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La Boite a Nems - Bandit Manchot</title>

  <style>
    :root{
      --bg:#0f0f12;
      --card:#1b1b22;
      --card2:#232332;
      --txt:#f3f3f3;
      --muted:#b9b9c7;
      --green:#2ecc71;
      --yellow:#f1c40f;
      --red:#ff5a5a;
      --line:rgba(255,255,255,.12);
    }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% 10%, rgba(255,255,255,.08), transparent 60%), var(--bg);
      color:var(--txt);
      text-align:center;
      padding:22px 12px;
    }
    h1{ margin:0 0 6px; letter-spacing:1px; font-size:34px; }
    .sub{ color:var(--muted); margin:0 0 18px; }

    .card{
      max-width:560px;
      margin:0 auto;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }

    .reels{
      display:flex;
      gap:14px;
      justify-content:center;
      margin:8px 0 12px;
      flex-wrap:wrap;
    }
    .reel{
      width:96px;
      height:86px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:44px;
      user-select:none;
      position:relative;
      overflow:hidden;
    }
    .reel.spin::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent, rgba(255,255,255,.10), transparent);
      animation: sheen .25s linear infinite;
    }
    @keyframes sheen{
      0%{ transform: translateY(-30%); }
      100%{ transform: translateY(30%); }
    }

    .btn{
      border:0;
      border-radius:12px;
      padding:14px 18px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition:.15s transform, .15s opacity;
      user-select:none;
    }
    .btn:active{ transform: scale(.98); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .spinBtn{
      background: var(--yellow);
      color:#1a1a1a;
      min-width:170px;
      margin:4px 0 8px;
    }

    .msg{
      margin:10px 0 10px;
      font-size:16px;
      font-weight:700;
      min-height:22px;
    }
    .msg.ok{ color:var(--green); }
    .msg.no{ color:var(--red); }

    .codeBox{
      display:none;
      margin:10px auto 6px;
      padding:12px 12px;
      max-width:520px;
      border-radius:12px;
      background: rgba(0,0,0,.25);
      border:1px dashed rgba(255,255,255,.22);
    }
    .codeBox b{
      display:block;
      font-size:20px;
      letter-spacing:1px;
      margin-top:6px;
    }
    #countdown, #claimCountdown{
      margin-top:8px;
      font-size:14px;
      font-weight:700;
      color: var(--muted);
    }

    .rowBtns{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin:12px 0 6px;
    }
    .linkBtn{
      background:#eaeaea;
      color:#111;
    }
    .greenBtn{
      background: var(--green);
      color:#102015;
    }

    .legend{
      margin-top:12px;
      text-align:left;
      max-width:520px;
      margin-left:auto;
      margin-right:auto;
      padding-top:10px;
      border-top:1px solid var(--line);
      color:#e8e8ef;
      font-size:14px;
      line-height:1.45;
    }
    .legend .title{ font-weight:800; margin-bottom:6px; }
    .tiny{ color:var(--muted); font-size:12.5px; margin-top:8px; }

    @media (max-width:420px){
      h1{ font-size:28px; }
      .reel{ width:88px; height:80px; font-size:40px; }
      .spinBtn{ min-width:160px; }
    }
  </style>
</head>

<body>
  <h1>LA BOITE A NEMS</h1>
  <p class="sub">Joue pour le fun... et parfois un cadeau</p>

  <div class="card">
    <div class="reels">
      <div class="reel" id="r1">7</div>
      <div class="reel" id="r2">7</div>
      <div class="reel" id="r3">7</div>
    </div>

    <button class="btn spinBtn" id="spinBtn" onclick="spin()">SPIN</button>

    <div class="msg" id="msg"></div>

    <div class="codeBox" id="codeBox">
      Code de reclamation (valable 10 min) :
      <b id="claimCode"></b>
      <div id="claimCountdown"></div>
      <div class="tiny">A montrer au camion (ou a donner au telephone).</div>
      <div id="countdown"></div>
    </div>

    <div class="rowBtns">
      <button class="btn linkBtn" onclick="goSite()">Decouvrir La Boite a Nems</button>
      <button class="btn greenBtn" onclick="callPhone()">Commander (telephone)</button>
      <button class="btn greenBtn" onclick="goWhatsApp()">Commander (WhatsApp)</button>
    </div>

    <div class="legend">
      <div class="title">Legende des gains</div>
      <div>üçí üçí üçí = 1 boisson soft (le plus souvent)</div>
      <div>‚≠ê ‚≠ê ‚≠ê = 1 box apero 8 pieces</div>
      <div>7 7 7 = 1 Pad thai traditionnel nature (tres rare)</div>

      <div style="margin-top:10px; border-top:1px solid var(--line); padding-top:10px;">
        <div>Commande minimum : <b>30 EUR</b></div>
        <div>Cadeau remis uniquement lors d'une commande (selon disponibilite).</div>
        <div>Gain valable <b>48h</b> a compter du gain.</div>
        <div>Si tu gagnes : tu ne peux plus rejouer pendant <b>24h</b> sur ce telephone.</div>
        <div>Un code de reclamation est genere (valable 10 min) pour limiter les profiteurs.</div>
      </div>
      <div class="tiny">Important : sans serveur, la protection anti-profiteurs est "par telephone/appareil" (localStorage). Le code 10 min sert de controle au camion/au tel.</div>
    </div>
  </div>

  <script>
    // =========================
    // REGLAGES
    // =========================
    const SITE_URL = "https://la-boite-a-nems-le-muy.eatbu.com";
    const PHONE = "+33782549660";

    // Probabilites de gain (approx) :
    // soft : 1/5, box : 1/8, pad : 1/20
    // On fait un tirage pondere propre
    const WEIGHTS = [
      { type: "soft", w: 20 }, // 20
      { type: "box",  w: 12 }, // 12
      { type: "pad",  w:  5 }, // 5
      { type: "lose", w: 63 }  // 63  -> total 100
    ];

    // blocage apres gain
    const BLOCK_AFTER_WIN_MS = 24 * 60 * 60 * 1000; // 24h
    // validite du gain
    const GAIN_VALID_MS = 48 * 60 * 60 * 1000; // 48h
    // validite du code reclamation
    const CLAIM_VALID_MS = 10 * 60 * 1000; // 10 min

    // =========================
    // SYMBOLS
    // =========================
    const SYM = {
      cherry: "üçí",
      star: "‚≠ê",
      seven: "7"
    };

    const reels = [
      document.getElementById("r1"),
      document.getElementById("r2"),
      document.getElementById("r3")
    ];
    const spinBtn = document.getElementById("spinBtn");
    const msgEl = document.getElementById("msg");

    const codeBox = document.getElementById("codeBox");
    const claimCodeEl = document.getElementById("claimCode");
    const countdownEl = document.getElementById("countdown");
    const claimCountdownEl = document.getElementById("claimCountdown");

    let countdownTimer = null;
    let claimTimer = null;

    function setMsg(text, cls){
      msgEl.className = "msg" + (cls ? (" " + cls) : "");
      msgEl.textContent = text || "";
    }

    function goSite(){
      window.open(SITE_URL, "_blank", "noopener");
    }
    function callPhone(){
      window.location.href = "tel:" + PHONE;
    }
    function goWhatsApp(){
      const wa = "https://wa.me/" + PHONE.replace("+","").replace(/\s+/g,"");
      window.open(wa, "_blank", "noopener");
    }

    // =========================
    // Anti-profiteurs (local)
    // =========================
    function nowMs(){ return Date.now(); }

    function isBlockedAfterWin(){
      const t = parseInt(localStorage.getItem("lastWinAt") || "0", 10);
      if(!t) return false;
      return (nowMs() - t) < BLOCK_AFTER_WIN_MS;
    }

    function timeLeft(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return {h,m,sec};
    }

    function fmtHMS(obj){
      const hh = String(obj.h).padStart(2,"0");
      const mm = String(obj.m).padStart(2,"0");
      const ss = String(obj.sec).padStart(2,"0");
      return hh + "h " + mm + "m " + ss + "s";
    }

    // =========================
    // Countdown (48h gain) + (10 min code)
    // =========================
    function stopCountdowns(){
      if(countdownTimer){ clearInterval(countdownTimer); countdownTimer = null; }
      if(claimTimer){ clearInterval(claimTimer); claimTimer = null; }
    }

    function refreshCountdowns(){
      stopCountdowns();

      const gainStart = parseInt(localStorage.getItem("gainStart") || "0", 10);
      const claimExp = parseInt(localStorage.getItem("claimExp") || "0", 10);
      const code = localStorage.getItem("claimCode") || "";
      const prize = localStorage.getItem("lastPrize") || "";

      // Si pas de gain en cours : on cache
      if(!gainStart || (nowMs() > gainStart + GAIN_VALID_MS)){
        localStorage.removeItem("gainStart");
        localStorage.removeItem("lastPrize");
        localStorage.removeItem("claimCode");
        localStorage.removeItem("claimExp");
        codeBox.style.display = "none";
        countdownEl.textContent = "";
        claimCountdownEl.textContent = "";
        claimCodeEl.textContent = "";
        return;
      }

      // Affiche box + code si encore valide (10 min)
      codeBox.style.display = "block";

      if(code && claimExp && nowMs() <= claimExp){
        claimCodeEl.textContent = code + " (" + prize + ")";
      } else {
        claimCodeEl.textContent = "(Code expire - demande nous au camion si besoin)";
        localStorage.removeItem("claimCode");
        localStorage.removeItem("claimExp");
      }

      // Timer 48h
      function updateGain(){
        const end = gainStart + GAIN_VALID_MS;
        const left = end - nowMs();
        if(left <= 0){
          refreshCountdowns();
          return;
        }
        countdownEl.textContent = "Temps restant pour recuperer le gain : " + fmtHMS(timeLeft(left));
      }
      updateGain();
      countdownTimer = setInterval(updateGain, 1000);

      // Timer 10 min code
      function updateClaim(){
        const exp = parseInt(localStorage.getItem("claimExp") || "0", 10);
        if(!exp){
          claimCountdownEl.textContent = "";
          return;
        }
        const left = exp - nowMs();
        if(left <= 0){
          claimCountdownEl.textContent = "Code expire.";
          localStorage.removeItem("claimCode");
          localStorage.removeItem("claimExp");
          return;
        }
        claimCountdownEl.textContent = "Validite code : " + fmtHMS(timeLeft(left));
      }
      updateClaim();
      claimTimer = setInterval(updateClaim, 1000);
    }

    // =========================
    // Tirage pondere
    // =========================
    function weightedPick(){
      let total = 0;
      for(const it of WEIGHTS) total += it.w;
      let r = Math.random() * total;
      for(const it of WEIGHTS){
        r -= it.w;
        if(r <= 0) return it.type;
      }
      return "lose";
    }

    // fabrique une combinaison gagnante / perdante
    function comboFor(outcome){
      if(outcome === "soft") return [SYM.cherry, SYM.cherry, SYM.cherry];
      if(outcome === "box")  return [SYM.star, SYM.star, SYM.star];
      if(outcome === "pad")  return [SYM.seven, SYM.seven, SYM.seven];

      // lose : combinaison qui n'est pas un triple gagnant
      const pool = [SYM.cherry, SYM.star, SYM.seven];
      while(true){
        const a = pool[Math.floor(Math.random()*pool.length)];
        const b = pool[Math.floor(Math.random()*pool.length)];
        const c = pool[Math.floor(Math.random()*pool.length)];
        const isTriple = (a===b && b===c);
        if(!isTriple) return [a,b,c];
        // si triple, on recommence
      }
    }

    // =========================
    // Code reclamation
    // =========================
    function makeClaimCode(){
      const d = new Date();
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const rnd = Math.floor(1000 + Math.random()*9000);
      return "NEMS-" + dd + mm + hh + mi + "-" + rnd;
    }

    // =========================
    // SPIN
    // =========================
    function spin(){
      // si bloque apres gain
      if(isBlockedAfterWin()){
        setMsg("Tu as deja gagne recemment. Reessaie dans 24h.", "no");
        refreshCountdowns();
        return;
      }

      spinBtn.disabled = true;
      setMsg("", "");
      reels.forEach(r => r.classList.add("spin"));

      // Decide resultat tout de suite (pour etre coherent)
      const outcome = weightedPick();
      const finalCombo = comboFor(outcome);

      // animation simple : on change vite les symboles
      const pool = [SYM.cherry, SYM.star, SYM.seven];
      let ticks = 0;
      const maxTicks = 18;

      const timer = setInterval(() => {
        ticks++;

        reels[0].textContent = pool[Math.floor(Math.random()*pool.length)];
        reels[1].textContent = pool[Math.floor(Math.random()*pool.length)];
        reels[2].textContent = pool[Math.floor(Math.random()*pool.length)];

        if(ticks >= maxTicks){
          clearInterval(timer);

          // stop + affiche vrai resultat
          reels[0].textContent = finalCombo[0];
          reels[1].textContent = finalCombo[1];
          reels[2].textContent = finalCombo[2];
          reels.forEach(r => r.classList.remove("spin"));

          if(outcome === "lose"){
            setMsg("Pas gagne cette fois. Retente ta chance quand tu veux.", "no");
            // on ne bloque pas
            refreshCountdowns();
            spinBtn.disabled = false;
            return;
          }

          // GAGNE
          let prizeLabel = "";
          if(outcome === "soft") prizeLabel = "1 boisson soft";
          if(outcome === "box")  prizeLabel = "1 box apero 8 pieces";
          if(outcome === "pad")  prizeLabel = "1 Pad thai traditionnel nature";

          setMsg("Gagne ! " + prizeLabel + ".", "ok");

          // lock 24h
          localStorage.setItem("lastWinAt", String(nowMs()));

          // gain valable 48h
          localStorage.setItem("gainStart", String(nowMs()));
          localStorage.setItem("lastPrize", prizeLabel);

          // code valable 10 min
          const code = makeClaimCode();
          localStorage.setItem("claimCode", code);
          localStorage.setItem("claimExp", String(nowMs() + CLAIM_VALID_MS));

          refreshCountdowns();
          spinBtn.disabled = false;
        }
      }, 90);
    }

    // =========================
    // INIT
    // =========================
    (function init(){
      // Message au chargement si bloque
      if(isBlockedAfterWin()){
        setMsg("Tu as deja gagne recemment. Reessaie dans 24h.", "no");
      } else {
        setMsg("", "");
      }
      refreshCountdowns();
    })();
  </script>
</body>
</html>
